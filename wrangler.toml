name = "the-wire"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

# Development settings
[dev]
port = 8080
local_protocol = "http"

# KV Namespaces
[[kv_namespaces]]
binding = "USERS_KV"
id = "689e9c3536ea4b319458c41783fb9815"
preview_id = "689e9c3536ea4b319458c41783fb9815"

[[kv_namespaces]]
binding = "POSTS_KV"
id = "9a6aeadbafcf41fc95e25adc0c09bfe8"
preview_id = "9a6aeadbafcf41fc95e25adc0c09bfe8"

[[kv_namespaces]]
binding = "SESSIONS_KV"
id = "2d2953c5d5114a198e19bd56277cc089"
preview_id = "2d2953c5d5114a198e19bd56277cc089"

[[kv_namespaces]]
binding = "FEEDS_KV"
id = "d34b5ede0bd14ee3b06156ef5a11dd19"
preview_id = "d34b5ede0bd14ee3b06156ef5a11dd19"

# R2 Buckets
[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "the-wire-media"
preview_bucket_name = "the-wire-media-preview"

# Durable Objects
[durable_objects]
bindings = [
  { name = "USER_DO", class_name = "UserDO" },
  { name = "POST_DO", class_name = "PostDO" },
  { name = "FEED_DO", class_name = "FeedDO" },
  { name = "WEBSOCKET_DO", class_name = "WebSocketDO" }
]

[[migrations]]
tag = "v1"
new_classes = ["UserDO", "PostDO", "FeedDO"]

[[migrations]]
tag = "v2"
new_classes = ["WebSocketDO"]

# Queues
[[queues.producers]]
binding = "FANOUT_QUEUE"
queue = "fanout-queue"

[[queues.consumers]]
queue = "fanout-queue"
max_batch_size = 100
max_batch_timeout = 30

# Cron Triggers
[triggers]
crons = [
  "*/15 * * * *",  # Every 15 minutes - update FoF rankings
  "0 * * * *",     # Every hour - cleanup old feed entries
  "0 0 * * *"      # Daily - compact KV storage
]

# Environment Variables
[vars]
ENVIRONMENT = "development"
JWT_EXPIRY_HOURS = "24"
MAX_NOTE_LENGTH = "280"
FEED_PAGE_SIZE = "20"

# Production overrides
[env.production]
name = "the-wire-production"
[env.production.vars]
ENVIRONMENT = "production"
