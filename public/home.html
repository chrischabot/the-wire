<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - The Wire</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="twitter-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar-left">
      <div class="logo">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"/>
        </svg>
      </div>

      <nav>
        <a href="/home" class="nav-item active">
          <svg viewBox="0 0 24 24"><path d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5A2.5 2.5 0 005.5 22h13a2.5 2.5 0 002.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z" fill="currentColor"/></svg>
          <span>Home</span>
        </a>
        <a href="#" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z" fill="currentColor"/></svg>
          <span>Explore</span>
        </a>
        <a href="#" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z" fill="currentColor"/></svg>
          <span>Notifications</span>
        </a>
        <a href="#" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z" fill="currentColor"/></svg>
          <span>Messages</span>
        </a>
        <a href="#" class="nav-item" id="profile-nav">
          <svg viewBox="0 0 24 24"><path d="M5.651 19h12.698c-.337-1.8-1.023-3.21-1.945-4.19C15.318 13.65 13.838 13 12 13s-3.317.65-4.404 1.81c-.922.98-1.608 2.39-1.945 4.19zm.486-5.56C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46zM12 4c-1.105 0-2 .9-2 2s.895 2 2 2 2-.9 2-2-.895-2-2-2zM8 6c0-2.21 1.791-4 4-4s4 1.79 4 4-1.791 4-4 4-4-1.79-4-4z" fill="currentColor"/></svg>
          <span>Profile</span>
        </a>
      </nav>

      <button class="post-button" id="open-compose">Post</button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="page-header">
        <h2>Home</h2>
      </header>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active">For you</button>
        <button class="tab">Following</button>
      </div>

      <!-- Compose Box -->
      <div class="compose-box">
        <div class="post-header">
          <img src="" alt="" class="avatar" id="compose-avatar">
          <div class="post-body" style="padding-top: 4px;">
            <textarea placeholder="What is happening?!" id="compose-textarea"></textarea>
          </div>
        </div>
        <div class="compose-footer">
          <div class="compose-actions">
            <button class="icon-button" title="Media">
              <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.5 7C8.119 7 7 8.119 7 9.5S8.119 12 9.5 12 12 10.881 12 9.5 10.881 7 9.5 7z" fill="currentColor"/></svg>
            </button>
            <button class="icon-button" title="GIF">
              <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 5.5C3 4.119 4.12 3 5.5 3h13C19.88 3 21 4.119 21 5.5v13c0 1.381-1.12 2.5-2.5 2.5h-13C4.12 21 3 19.881 3 18.5v-13zM5.5 5c-.28 0-.5.224-.5.5v13c0 .276.22.5.5.5h13c.28 0 .5-.224.5-.5v-13c0-.276-.22-.5-.5-.5h-13zM18 10.711V9.25h-3.74v5.5h1.44v-1.719h1.7V11.57h-1.7v-.859H18zM11.79 9.25h1.44v5.5h-1.44v-5.5zm-3.07 1.375c.34 0 .77.172 1.02.43l1.03-.86c-.51-.601-1.28-.945-2.05-.945C7.19 9.25 6 10.453 6 12s1.19 2.75 2.72 2.75c.85 0 1.54-.344 2.05-.945v-2.149H8.38v1.032H9.4v.515c-.17.086-.42.172-.68.172-.76 0-1.36-.602-1.36-1.375s.6-1.375 1.36-1.375z" fill="currentColor"/></svg>
            </button>
            <button class="icon-button" title="Emoji">
              <svg viewBox="0 0 24 24" width="20" height="20"><path d="M8 9.5C8 8.119 8.672 7 9.5 7S11 8.119 11 9.5 10.328 12 9.5 12 8 10.881 8 9.5zm6.5 2.5c.828 0 1.5-1.119 1.5-2.5S15.328 7 14.5 7 13 8.119 13 9.5s.672 2.5 1.5 2.5zM12 16c-2.224 0-3.021-2.227-3.051-2.316l-1.897.633c.05.15 1.271 3.684 4.949 3.684s4.898-3.533 4.949-3.684l-1.896-.638c-.033.095-.83 2.322-3.054 2.322zm10.25-4.001c0 5.652-4.598 10.25-10.25 10.25S1.75 17.652 1.75 12 6.348 1.75 12 1.75 22.25 6.348 22.25 12zm-2 0c0-4.549-3.701-8.25-8.25-8.25S3.75 7.451 3.75 12s3.701 8.25 8.25 8.25 8.25-3.701 8.25-8.25z" fill="currentColor"/></svg>
            </button>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="char-counter" id="char-counter">280</span>
            <button class="tweet-button" id="post-btn" disabled>Post</button>
          </div>
        </div>
      </div>

      <!-- Feed -->
      <div id="feed-container">
        <div class="empty-state" id="loading-state">Loading...</div>
      </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
      <div class="search-box">
        <input type="text" class="search-input" placeholder="Search">
      </div>
    </aside>
  </div>

  <!-- Dropdown backdrop -->
  <div class="dropdown-backdrop hidden" id="dropdown-backdrop"></div>

  <script src="/js/api.js"></script>
  <script>
    // State
    let currentUser = null;
    let openDropdown = null;

    // Check if authenticated
    if (!auth.isAuthenticated()) {
      window.location.href = '/login';
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (seconds < 60) return `${seconds}s`;
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;

      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Format number
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Close all dropdowns
    function closeAllDropdowns() {
      document.querySelectorAll('.post-dropdown.open').forEach(dropdown => {
        dropdown.classList.remove('open');
      });
      document.getElementById('dropdown-backdrop').classList.add('hidden');
      openDropdown = null;
    }

    // Toggle dropdown
    function toggleDropdown(postId) {
      const dropdown = document.getElementById(`dropdown-${postId}`);
      const backdrop = document.getElementById('dropdown-backdrop');

      if (openDropdown === postId) {
        closeAllDropdowns();
        return;
      }

      closeAllDropdowns();
      dropdown.classList.add('open');
      backdrop.classList.remove('hidden');
      openDropdown = postId;
    }

    // Delete post
    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) {
        return;
      }

      try {
        await posts.delete(postId);
        // Remove the post from the DOM
        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
        if (postElement) {
          postElement.remove();
        }
        closeAllDropdowns();
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post: ' + error.message);
      }
    }

    // Toggle like
    async function toggleLike(postId, isLiked) {
      try {
        if (isLiked) {
          await posts.unlike(postId);
        } else {
          await posts.like(postId);
        }
        // Reload feed to update state
        loadFeed();
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    // Render a single post
    function renderPost(post) {
      const isOwnPost = currentUser && post.authorId === currentUser.id;

      return `
        <article class="post-card" data-post-id="${post.id}">
          <div class="post-header">
            <img src="${post.authorAvatarUrl || '/images/default-avatar.png'}" alt="" class="avatar" onerror="this.src='/images/default-avatar.png'">
            <div class="post-body">
              <div class="post-header-top">
                <div class="post-author-row">
                  <a href="/profile/${post.authorHandle}" class="post-author">${post.authorDisplayName || post.authorHandle}</a>
                  <a href="/profile/${post.authorHandle}" class="post-handle">@${post.authorHandle}</a>
                  <span class="post-timestamp">${formatTimestamp(post.createdAt)}</span>
                </div>
                <div class="post-menu-container">
                  <button class="post-more-btn" onclick="event.stopPropagation(); toggleDropdown('${post.id}')" aria-label="More options">
                    <svg viewBox="0 0 24 24">
                      <circle cx="5" cy="12" r="2"></circle>
                      <circle cx="12" cy="12" r="2"></circle>
                      <circle cx="19" cy="12" r="2"></circle>
                    </svg>
                  </button>
                  <div class="post-dropdown" id="dropdown-${post.id}">
                    ${isOwnPost ? `
                      <button class="post-dropdown-item destructive" onclick="event.stopPropagation(); deletePost('${post.id}')">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                          <path d="M16 6V4.5C16 3.12 14.88 2 13.5 2h-3C9.11 2 8 3.12 8 4.5V6H3v2h1.06l.81 11.21C4.98 20.78 6.28 22 7.86 22h8.27c1.58 0 2.88-1.22 3-2.79L19.93 8H21V6h-5zm-6-1.5c0-.28.22-.5.5-.5h3c.27 0 .5.22.5.5V6h-4V4.5zm7.13 14.57c-.04.52-.47.93-1 .93H7.86c-.53 0-.96-.41-1-.93L6.07 8h11.85l-.79 11.07z"/>
                        </svg>
                        Delete
                      </button>
                    ` : ''}
                    <button class="post-dropdown-item" onclick="event.stopPropagation(); closeAllDropdowns()">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm1-4h-2v-2h2v2zm0-4h-2V7h2v5z"/>
                      </svg>
                      Not interested
                    </button>
                    <button class="post-dropdown-item" onclick="event.stopPropagation(); navigator.clipboard.writeText(window.location.origin + '/post/' + '${post.id}'); closeAllDropdowns()">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.36 5.64c-1.95-1.96-5.11-1.96-7.07 0L9.88 7.05 8.46 5.64l1.42-1.42c2.73-2.73 7.16-2.73 9.9 0 2.73 2.74 2.73 7.17 0 9.9l-1.42 1.42-1.41-1.42 1.41-1.41c1.96-1.96 1.96-5.12 0-7.07zm-2.12 3.53l-7.07 7.07-1.41-1.41 7.07-7.07 1.41 1.41zm-12.02.71l1.42-1.42 1.41 1.42-1.41 1.41c-1.96 1.96-1.96 5.12 0 7.07 1.95 1.96 5.11 1.96 7.07 0l1.41-1.41 1.42 1.41-1.42 1.42c-2.73 2.73-7.16 2.73-9.9 0-2.73-2.74-2.73-7.17 0-9.9z"/>
                      </svg>
                      Copy link
                    </button>
                  </div>
                </div>
              </div>
              <div class="post-content">${escapeHtml(post.content)}</div>
              <div class="post-actions">
                <button class="post-action" onclick="event.stopPropagation()">
                  <svg viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z" fill="currentColor"/></svg>
                  <span>${post.replyCount > 0 ? formatNumber(post.replyCount) : ''}</span>
                </button>
                <button class="post-action" onclick="event.stopPropagation()">
                  <svg viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z" fill="currentColor"/></svg>
                  <span>${post.repostCount > 0 ? formatNumber(post.repostCount) : ''}</span>
                </button>
                <button class="post-action ${post.hasLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLike('${post.id}', ${post.hasLiked || false})">
                  <svg viewBox="0 0 24 24"><path d="${post.hasLiked ? 'M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z' : 'M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z'}" fill="currentColor"/></svg>
                  <span>${post.likeCount > 0 ? formatNumber(post.likeCount) : ''}</span>
                </button>
                <button class="post-action" onclick="event.stopPropagation()">
                  <svg viewBox="0 0 24 24"><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z" fill="currentColor"/></svg>
                </button>
              </div>
            </div>
          </div>
        </article>
      `;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load user info
    async function loadUserInfo() {
      try {
        const response = await auth.me();
        if (response.success) {
          currentUser = response.data;
          document.getElementById('compose-avatar').src = currentUser.avatarUrl || '/images/default-avatar.png';
          document.getElementById('profile-nav').href = `/profile/${currentUser.handle}`;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        window.location.href = '/login';
      }
    }

    // Load feed
    async function loadFeed() {
      const container = document.getElementById('feed-container');

      try {
        const response = await feed.getHome();

        if (response.success && response.data.posts && response.data.posts.length > 0) {
          container.innerHTML = response.data.posts.map(item => renderPost(item.post || item)).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <p>No posts yet</p>
              <p class="text-muted mt-1">Follow some people to see their posts here, or create your first post!</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading feed:', error);
        container.innerHTML = `
          <div class="empty-state">
            <p>Welcome to The Wire!</p>
            <p class="text-muted mt-1">Create your first post to get started.</p>
          </div>
        `;
      }
    }

    // Initialize compose box
    function initCompose() {
      const textarea = document.getElementById('compose-textarea');
      const charCounter = document.getElementById('char-counter');
      const postBtn = document.getElementById('post-btn');
      const maxLength = 280;

      textarea.addEventListener('input', () => {
        const remaining = maxLength - textarea.value.length;
        charCounter.textContent = remaining;

        charCounter.classList.remove('warning', 'error');
        if (remaining < 0) {
          charCounter.classList.add('error');
        } else if (remaining < 20) {
          charCounter.classList.add('warning');
        }

        postBtn.disabled = textarea.value.trim().length === 0 || remaining < 0;

        // Auto-expand textarea
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      });

      postBtn.addEventListener('click', async () => {
        const content = textarea.value.trim();
        if (!content) return;

        postBtn.disabled = true;
        postBtn.textContent = 'Posting...';

        try {
          await posts.create(content);
          textarea.value = '';
          textarea.style.height = 'auto';
          charCounter.textContent = maxLength;
          postBtn.textContent = 'Post';
          loadFeed();
        } catch (error) {
          console.error('Error creating post:', error);
          alert('Failed to create post: ' + error.message);
          postBtn.disabled = false;
          postBtn.textContent = 'Post';
        }
      });
    }

    // Event listeners
    document.getElementById('dropdown-backdrop').addEventListener('click', closeAllDropdowns);

    // Close dropdown on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAllDropdowns();
      }
    });

    // Initialize
    loadUserInfo();
    loadFeed();
    initCompose();
  </script>
</body>
</html>
